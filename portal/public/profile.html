<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Profile</title>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/global.css">
    <script src="/js/header.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <h2>Edit Profile</h2>
        
        <div class="upload-box">
            <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
                <img id="profilePreview" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid var(--purple-main);">
                <div>
                    <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="uploadPhoto()">
                    <button class="btn-primary" onclick="document.getElementById('photoInput').click()">Change Photo</button>
                    <p style="font-size:0.8rem; color:#aaa; margin-top:5px;">Max 2MB</p>
                </div>
            </div>

            <form onsubmit="updateProfile(event)">
                <label>Full Name</label>
                <input type="text" id="pName" required>
                
                <label>Institute</label>
                <input type="text" id="pInst">

                <label style="margin-top:15px; display:block; color:#aaa; font-size:0.9rem;">Social Links</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="pTwitter" placeholder="X URL">
                    <input type="text" id="pInstagram" placeholder="Instagram URL">
                    <input type="text" id="pFacebook" placeholder="Facebook URL">
                    <input type="text" id="pWebsite" placeholder="Portfolio/Website URL">
                </div>
                
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>Phone No</label>
                        <input type="text" id="pPhone">
                    </div>
                    <div style="flex:1;">
                        <label>Date of Birth</label>
                        <input type="date" id="pDob">
                    </div>
                </div>

                <label>Study Level</label>
                <select id="pLevel">
                    <option value="Preschool">Preschool</option>
                    <option value="1">Class 1</option>
                    <option value="2">Class 2</option>
                    <option value="3">Class 3</option>
                    <option value="4">Class 4</option>
                    <option value="5">Class 5</option>
                    <option value="6">Class 6</option>
                    <option value="7">Class 7</option>
                    <option value="8">Class 8</option>
                    <option value="9">Class 9</option>
                    <option value="10">Class 10</option>
                    <option value="11">Class 11</option>
                    <option value="12">Class 12</option>
                    <option value="bachelors">Bachelors</option>
                    <option value="masters">Masters</option>
                    <option value="open">Open Category</option>
                </select>

                <label>Bio</label>
                <textarea id="pBio" rows="3"></textarea>

                <button type="submit" class="btn-primary">Save Changes</button>
            </form>
        </div>

        <div class="upload-box" style="margin-top:30px; border-color: #d32f2f;">
            <h3>Change Password</h3>
            <form onsubmit="changePass(event)">
                <input type="password" id="oldPass" placeholder="Current Password" required>
                <input type="password" id="newPass" placeholder="New Password" required>
                <input type="password" id="confirmPass" placeholder="Confirm New Password" required>
                <button type="submit" class="delete-btn" style="width:100%; padding:10px;">Update Password</button>
            </form>
        </div>
        <div class="upload-box" style="margin-top:30px; border-color: var(--green-main);">
            <h3>My Connections</h3>
            
            <h4 style="color:#aaa; margin-top:20px;">Pending Requests</h4>
            <div id="pendingList" style="margin-bottom:20px;"></div>
        
            <h4 style="color:#aaa;">My Friends</h4>
            <div id="friendsList"></div>
        </div>
        <div class="upload-box" style="margin-top:30px; border-color: #ff9800;">
            <h3>Contest History</h3>
            <div id="contestList" style="margin-top:15px;">
                <p style="color:#aaa;">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('authToken');
        if(!token) window.location.href = '/join';

        window.onload = async () => {
            const res = await fetch('/api/profile/me', { headers: { 'Authorization': `Bearer ${token}` } });
            const u = await res.json();
            
            document.getElementById('pName').value = u.full_name || "";
            document.getElementById('pInst').value = u.institute || "";
            document.getElementById('pPhone').value = u.phone_no || "";
            document.getElementById('pBio').value = u.short_bio || "";
            if(u.study_level) document.getElementById('pLevel').value = u.study_level;
            if(u.date_of_birth) document.getElementById('pDob').value = u.date_of_birth.split('T')[0];
            if(u.profile_pic_url) document.getElementById('profilePreview').src = u.profile_pic_url;
            if(u.twitter_url) document.getElementById('pTwitter').value = u.twitter_url;
            if(u.instagram_url) document.getElementById('pInstagram').value = u.instagram_url;
            if(u.facebook_url) document.getElementById('pFacebook').value = u.facebook_url;
            if(u.website_url) document.getElementById('pWebsite').value = u.website_url;

        loadMyFriends(); 
        loadContests();

};

        async function loadMyFriends() {
            const listP = document.getElementById('pendingList');
            const listF = document.getElementById('friendsList');
            listP.innerHTML = "<p>Loading...</p>";
            
            try {
                const res = await fetch('/api/my-friends', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                if (data.requests.length === 0) listP.innerHTML = "<p style='color:#666; font-style:italic;'>No pending requests.</p>";
                else {
                    listP.innerHTML = data.requests.map(u => `
                        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${u.profile_pic_url || '/default-avatar.png'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                                <div>
                                    <div style="font-weight:bold;"><a href="/u/${u.username}" style="color:white; text-decoration:none;">${u.full_name}</a></div>
                                    <div style="font-size:0.8rem; color:#aaa;">@${u.username}</div>
                                </div>
                            </div>
                            <div>
                                <button class="action-btn" style="background:var(--green-main); color:black;" onclick="respondFriend('${u.user_id}', 'accept')">Accept</button>
                                <button class="action-btn" style="background:#d32f2f;" onclick="respondFriend('${u.user_id}', 'reject')">Reject</button>
                            </div>
                        </div>
                    `).join('');
                }

                if (data.friends.length === 0) listF.innerHTML = "<p style='color:#666; font-style:italic;'>No friends added yet.</p>";
                else {
                    listF.innerHTML = data.friends.map(u => `
                        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${u.profile_pic_url || '/default-avatar.png'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                                <div>
                                    <div style="font-weight:bold;"><a href="/u/${u.username}" style="color:white; text-decoration:none;">${u.full_name}</a></div>
                                    <div style="font-size:0.8rem; color:#aaa;">@${u.username}</div>
                                </div>
                            </div>
                            <button class="action-btn" style="background:transparent; border:1px solid #d32f2f; color:#d32f2f;" onclick="respondFriend('${u.user_id}', 'remove')">Remove</button>
                        </div>
                    `).join('');
                }

            } catch (e) { console.error(e); }
        }

        async function respondFriend(id, action) {
            let url = `/api/friends/${id}`;
            let method = 'DELETE';

            if (action === 'accept') { url = `/api/friends/accept/${id}`; method = 'POST'; }
            if (action === 'remove' && !confirm("Remove this friend?")) return;

            await fetch(url, { method, headers: { 'Authorization': `Bearer ${token}` } });
            loadMyFriends();
        }

        async function uploadPhoto() {
            const file = document.getElementById('photoInput').files[0];
            if(!file) return;
            
            const formData = new FormData();
            formData.append('photo', file);

            const res = await fetch('/api/profile/upload-photo', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            if(res.ok) {
                const data = await res.json();
                document.getElementById('profilePreview').src = data.url;
            } else {
                alert("Upload failed (Max 2MB)");
            }
        }

        async function updateProfile(e) {
            e.preventDefault();
            const body = {
                full_name: document.getElementById('pName').value,
                institute: document.getElementById('pInst').value,
                phone_no: document.getElementById('pPhone').value,
                study_level: document.getElementById('pLevel').value,
                short_bio: document.getElementById('pBio').value,
                dob: document.getElementById('pDob').value,
                twitter: document.getElementById('pTwitter').value,
                instagram: document.getElementById('pInstagram').value,
                facebook: document.getElementById('pFacebook').value,
                website: document.getElementById('pWebsite').value
            };
            
            const res = await fetch('/api/profile/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(body)
            });
            if(res.ok) alert("Profile Saved!");
        }

        async function loadContests() {
        const container = document.getElementById('contestList');
        if (!container) return;

        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const myId = payload.userId;

            const res = await fetch(`/api/contest/history/${myId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const contests = await res.json();
            
            if (contests.length === 0) {
                container.innerHTML = "<p style='color:#666; font-style:italic;'>You haven't participated in any contests yet.</p>";
                return;
            }

            container.innerHTML = contests.map(c => {
                const dateObj = new Date(c.start_time);
                const dateStr = dateObj.toLocaleDateString();
                const title = `Custom Virtual Contest ${dateStr}`;
                
                const total = c.total_questions || 0;
                const correct = c.correct_count || 0;
                const acc = total > 0 ? Math.round((correct / total) * 100) : 0;
                const accColor = acc >= 80 ? 'var(--green-main)' : (acc >= 50 ? '#ff9800' : 'var(--red-main)');

                const link = c.public_id ? `/contest-history.html?id=${c.public_id}` : '#';
                const cursorStyle = c.public_id ? 'pointer' : 'default';

                return `
                <div class="list-item" onclick="window.location.href='${link}'" style="cursor:${cursorStyle}; display:block; margin-bottom:10px; background:rgba(255,255,255,0.03); transition:0.2s;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:bold; color:white; font-size:1.05rem;">${title}</div>
                            <div style="font-size:0.85rem; color:#aaa; margin-top:4px;">
                                Accuracy: <span style="color:${accColor}; font-weight:bold;">${acc}%</span> 
                                (${correct}/${total})
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:bold; color:var(--purple-main); font-size:1.1rem;">
                                ${parseFloat(c.score_obtained).toFixed(2)} Pts
                            </div>
                            <div style="font-size:0.7rem; color:#666; margin-top:5px;">Click to view</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        } catch (e) {
            console.error(e);
            container.innerHTML = "<p style='color:red;'>Failed to load history.</p>";
        }
}

    async function toggleContestVisibility(id, currentStatus, btn) {
        const newStatus = !currentStatus;
        btn.innerText = "Updating...";
        try {
            const res = await fetch(`/api/contest/${id}/visibility`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ isPublic: newStatus })
            });
            if (res.ok) {
                btn.innerText = newStatus ? 'Public' : 'Private';
                btn.style.background = newStatus ? 'var(--green-main)' : 'transparent';
                btn.style.borderColor = newStatus ? 'var(--green-main)' : '#555';
                btn.style.color = newStatus ? 'black' : '#aaa';
                btn.onclick = () => toggleContestVisibility(id, newStatus, btn);
            }
        } catch (e) { btn.innerText = currentStatus ? 'Public' : 'Private'; }
    }
    </script>
</body>
</html>